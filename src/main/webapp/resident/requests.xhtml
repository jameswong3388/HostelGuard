<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:pe="http://primefaces.org/ui/extensions"
                template="/WEB-INF/templates/resident-layout.xhtml">

    <ui:define name="title">Requests</ui:define>

    <ui:define name="navigation">
        <h:link outcome="/resident/requests.xhtml" styleClass="py-2 text-blue-600 font-medium">
            Visit Requests
        </h:link>
    </ui:define>

    <ui:define name="content">
        <!-- New Request Dialog -->
        <p:dialog header="New Visit Request"
                  widgetVar="newRequestDialog"
                  modal="true"
                  width="500">
            <h:form id="newRequestForm">
                <div class="p-fluid">
                    <!-- Unit Number (Read-only) -->
                    <div class="field mb-4">
                        <p:outputLabel for="unitNumber" value="Unit Number"/>
                        <p:inputText id="unitNumber"
                                     value="#{visitRequestControllerResident.residentProfile.unitNumber}"
                                     readonly="true"/>
                    </div>

                    <!-- Verification Code -->
                    <div class="field mb-4">
                        <p:outputLabel for="verificationCode" value="Verification Code"/>
                        <p:inputText id="verificationCode"
                                     value="#{visitRequestControllerResident.newRequest.verificationCode}"/>
                    </div>

                    <!-- Combined Date/Time -->
                    <div class="field mb-4">
                        <p:outputLabel for="visitDateTime" value="Visit Date/Time"/>
                        <p:datePicker id="visitDateTime"
                                      value="#{visitRequestControllerResident.newRequest.visitDateTime}"
                                      pattern="MM/dd/yy HH:mm"
                                      showTime="true"
                                      showIcon="true"
                                      converter="timestampConverter"
                                      required="true"/>
                    </div>

                    <!-- Purpose -->
                    <div class="field mb-4">
                        <p:outputLabel for="purpose" value="Purpose"/>
                        <p:inputTextarea id="purpose"
                                         value="#{visitRequestControllerResident.newRequest.purpose}"
                                         required="true"
                                         rows="3"/>
                    </div>

                    <div class="flex justify-content-end gap-4">
                        <p:commandButton value="Cancel"
                                         icon="pi pi-times"
                                         onclick="PF('newRequestDialog').hide(); return false;"
                                         styleClass="p-button-text mr-2"
                                         immediate="true"/>
                        <p:commandButton value="Submit"
                                         icon="pi pi-check"
                                         action="#{visitRequestControllerResident.createRequest}"
                                         update=":messages @form :requestsTableForm:requestsTable :qrCodeForm"
                                         styleClass="p-button-primary"
                                         oncomplete="if (!args.validationFailed) { PF('newRequestDialog').hide(); PF('qrCodeDialog').show(); }"/>
                    </div>
                </div>
            </h:form>
        </p:dialog>

        <!-- QR Code Dialog -->
        <p:dialog header="Visit Verification Code"
                  widgetVar="qrCodeDialog"
                  modal="true"
                  width="400"
                  appendTo="@(body)">
            <h:form id="qrCodeForm">
                <div class="flex flex-col items-center space-y-4">
                    <pe:qrCode
                            label="HostelGuard"
                            text="#{visitRequestControllerResident.currentQrCode}"
                            fillColor="#000000"
                               renderMethod="image"
                               renderMode="0"
                               width="200"
                               height="200"
                               type="qr"
                            radius="0.5"
                    />
                    <p:outputLabel value="Verification Code: #{visitRequestControllerResident.currentQrCode}"
                                   styleClass="font-mono text-lg font-bold"/>
                    <p class="mt-4 text-sm text-gray-600">
                        Scan this QR code at the security gate for verification
                    </p>
                </div>
            </h:form>
        </p:dialog>

        <!-- Editable Table of Previous Requests -->
        <h:form id="requestsTableForm">
            <p:toolbar>
                <p:toolbarGroup>
                    <!-- "New Request" triggers the same dialog you already have -->
                    <p:commandButton value="New Request"
                                     icon="pi pi-plus"
                                     styleClass="ui-button-success"
                                     onclick="PF('newRequestDialog').show(); return false;"
                                     style="margin-right: .5rem"/>
                </p:toolbarGroup>
            </p:toolbar>

            <!-- DataTable with multi-select, global filter, paging, row editing -->
            <p:dataTable id="requestsTable"
                         widgetVar="requestsTable"
                         var="req"
                         value="#{visitRequestControllerResident.userRequests}"
                         reflow="true"
                         rowKey="#{req.id}"
                         paginator="true"
                         rows="10"
                         selectionRowMode="add"
                         paginatorPosition="bottom"
                         selection="#{visitRequestControllerResident.selectedRequests}"
                         styleClass="w-full border rounded-md mt-2"
                         filteredValue="#{visitRequestControllerResident.filteredRequests}"
                         globalFilterFunction="#{visitRequestControllerResident.globalFilterFunction}"
                         editable="true"
                         editMode="row">

                <!-- Global search bar in the header facet -->
                <f:facet name="header">
                    <div class="flex justify-between">
                        <span class="filter-container ui-input-icon-left">
                            <i class="pi pi-search"></i>
                            <p:inputText id="globalFilter"
                                         onkeyup="PF('requestsTable').filter()"
                                         placeholder="Search all fields"/>
                        </span>
                    </div>
                </f:facet>

                <!-- Checkboxes for multi-select -->
                <p:column selectionMode="multiple" exportable="false" style="width:1px"/>

                <!-- Verification Code -->
                <p:column headerText="Verification Code" sortBy="#{req.verificationCode}">
                    <p:cellEditor>
                        <f:facet name="output">
                            <h:outputText value="#{req.verificationCode}"/>
                        </f:facet>
                        <f:facet name="input">
                            <p:inputText value="#{req.verificationCode}"/>
                        </f:facet>
                    </p:cellEditor>
                </p:column>

                <!-- Single Column: Timestamp (Date/Time) -->
                <p:column headerText="Visit Date/Time" sortBy="#{req.visitDateTime}">
                    <p:cellEditor>
                        <f:facet name="output">
                            <h:outputText value="#{req.visitDateTime}">
                                <f:convertDateTime pattern="MM/dd/yy HH:mm"/>
                            </h:outputText>
                        </f:facet>
                        <f:facet name="input">
                            <p:datePicker value="#{req.visitDateTime}"
                                          pattern="MM/dd/yy HH:mm"
                                          showTime="true"
                                          showIcon="true"
                                          converter="timestampConverter"/>
                        </f:facet>
                    </p:cellEditor>
                </p:column>

                <!-- Purpose -->
                <p:column headerText="Purpose" sortBy="#{req.purpose}">
                    <p:cellEditor>
                        <f:facet name="output">
                            <h:outputText value="#{req.purpose}"/>
                        </f:facet>
                        <f:facet name="input">
                            <p:inputTextarea value="#{req.purpose}"
                                             rows="2"
                                             autoResize="false"/>
                        </f:facet>
                    </p:cellEditor>
                </p:column>

                <!-- Show the single status from VisitRequestStatus (disabled editing) -->
                <p:column headerText="Status" sortBy="#{req.status}">
                    <p:cellEditor disabled="true">
                        <f:facet name="output">
                            <p:tag severity="#{req.status eq 'PENDING' ? 'warning' :
                                              req.status eq 'APPROVED' ? 'info' :
                                              req.status eq 'COMPLETED' ? 'success' :
                                              req.status eq 'CANCELLED' ? 'info' : 'danger'}"
                                   value="#{req.status}"/>
                        </f:facet>
                        <f:facet name="input">
                            <p:inputText value="#{req.status}"/>
                        </f:facet>
                    </p:cellEditor>
                </p:column>

                <!-- Remarks (disabled editing) -->
                <p:column headerText="Remarks" sortBy="#{req.remarks}">
                    <p:cellEditor disabled="true">
                        <f:facet name="output">
                            <h:outputText value="#{req.remarks}"/>
                        </f:facet>
                        <f:facet name="input">
                            <p:inputTextarea value="#{req.remarks}" rows="2" autoResize="true"/>
                        </f:facet>
                    </p:cellEditor>
                </p:column>

                <!-- Row edit events -->
                <p:ajax event="rowEdit"
                        listener="#{visitRequestControllerResident.onRowEdit}"
                        update=":requestsTableForm:requestsTable :messages"/>
                <p:ajax event="rowEditCancel"
                        listener="#{visitRequestControllerResident.onRowCancel}"
                        update=":requestsTableForm:requestsTable :messages"/>

                <!-- Row Editor column (hidden if status = 'CANCELLED') -->
                <p:column headerText="Edit">
                    <p:rowEditor editTitle="Edit"
                                 cancelTitle="Cancel"
                                 saveTitle="Save"
                                 rendered="#{req.status ne 'CANCELLED'}"/>
                </p:column>

                <!-- Cancel Request Button, hidden if already cancelled -->
                <p:column headerText="Cancel">
                    <p:commandButton value="Cancel Request"
                                     icon="pi pi-ban"
                                     styleClass="p-button-danger"
                                     action="#{visitRequestControllerResident.cancelRequest(req)}"
                                     update=":requestsTableForm:requestsTable :messages"
                                     rendered="#{req.status ne 'CANCELLED'}"/>
                </p:column>
            </p:dataTable>
        </h:form>
    </ui:define>
</ui:composition>
