<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:pe="http://primefaces.org/ui/extensions"
                template="/WEB-INF/templates/resident-layout.xhtml">

    <ui:define name="title">Requests - HostelGuard™</ui:define>

    <ui:define name="navigation">
        <h:link outcome="/resident/requests.xhtml" styleClass="py-2 text-blue-600 font-medium">
            Visit Requests
        </h:link>
    </ui:define>

    <ui:define name="content">
        <p:sidebar id="newRequestSidebar"
                   widgetVar="newRequestSidebar"
                   position="right"
                   style="width:600px;">
            <h:form id="newRequestForm">
                <div class="space-y-4">
                    <!-- Sidebar Title -->
                    <h2 class="text-xl font-semibold mb-4">New Visit Request</h2>

                    <!-- Unit Number (Read-only) -->
                    <div class="field mb-4">
                        <p:outputLabel for="unitNumber" value="Unit Number" styleClass="block mb-1"/>
                        <p:inputText id="unitNumber"
                                     value="#{visitRequestControllerResident.residentProfile.unitNumber}"
                                     readonly="true"
                                     styleClass="w-full"/>
                    </div>

                    <!-- Verification Code -->
                    <div class="field mb-4">
                        <p:outputLabel for="verificationCode" value="Verification Code" styleClass="block mb-1"/>
                        <p:inputText id="verificationCode"
                                     value="#{visitRequestControllerResident.newRequest.verificationCode}"
                                     styleClass="w-full"/>
                    </div>

                    <!-- Combined Date/Time -->
                    <div class="field mb-4">
                        <p:outputLabel for="visitDateTime" value="Visit Date/Time" styleClass="block mb-1"/>
                        <p:datePicker id="visitDateTime"
                                      value="#{visitRequestControllerResident.newRequest.visitDateTime}"
                                      pattern="MM/dd/yy HH:mm"
                                      showTime="true"
                                      converter="timestampConverter"
                                      required="true"
                                      styleClass="w-full"/>
                    </div>

                    <!-- Number of Entries -->
                    <div class="field mb-4">
                        <p:outputLabel for="numberOfEntries" value="Number of Entries" styleClass="block mb-1"/>
                        <p:inputText id="numberOfEntries"
                                     value="#{visitRequestControllerResident.newRequest.numberOfEntries}"
                                     required="true"
                                     styleClass="w-full"/>
                    </div>

                    <!-- Purpose -->
                    <div class="field mb-4">
                        <p:outputLabel for="purpose" value="Purpose" styleClass="block mb-1"/>
                        <p:inputTextarea id="purpose"
                                         value="#{visitRequestControllerResident.newRequest.purpose}"
                                         required="true"
                                         rows="3"
                                         styleClass="w-full"/>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex justify-content-end gap-4">
                        <p:commandButton value="Cancel"
                                         icon="pi pi-times"
                                         onclick="PF('newRequestSidebar').hide(); return false;"
                                         styleClass="p-button-text mr-2 ui-button-warning"
                                         immediate="true"/>
                        <p:commandButton value="Submit"
                                         icon="pi pi-check"
                                         action="#{visitRequestControllerResident.createRequest}"
                                         update=":messages @form :requestsTableForm:requestsTable :qrCodeForm"
                                         styleClass="p-button-primary"
                                         oncomplete="if (!args.validationFailed) { PF('newRequestSidebar').hide(); PF('qrCodeDialog').show(); }"/>
                    </div>
                </div>
            </h:form>
        </p:sidebar>

        <!-- QR Code Dialog -->
        <p:dialog header="Visit Verification Code"
                  widgetVar="qrCodeDialog"
                  modal="true"
                  width="400"
                  appendTo="@(body)">
            <h:form id="qrCodeForm">
                <div class="flex flex-col items-center space-y-4">
                    <pe:qrCode
                            label="HostelGuard™"
                            text="#{visitRequestControllerResident.currentQrCode}"
                            fillColor="#000000"
                            fontColor="#2b5cf2"
                            renderMethod="canvas"
                            renderMode="2"
                            size="200"
                            radius="0.5"
                            ecLevel="H"
                    />
                    <p:outputLabel value="Verification Code: #{visitRequestControllerResident.currentQrCode}"
                                   styleClass="font-mono text-lg font-bold"/>
                    <p class="mt-4 text-sm text-gray-600">
                        Scan this QR code at the security gate for verification
                    </p>
                </div>
            </h:form>
        </p:dialog>

        <!-- Editable Table of Previous Requests -->
        <h:form id="requestsTableForm">
            <p:toolbar>
                <p:toolbarGroup>
                    <!-- "New Request" triggers the sidebar now -->
                    <p:commandButton value="New Request"
                                     icon="pi pi-plus"
                                     styleClass="ui-button-success"
                                     onclick="PF('newRequestSidebar').show(); return false;"
                                     style="margin-right: .5rem"/>
                </p:toolbarGroup>
            </p:toolbar>

            <!-- DataTable with multi-select, global filter, paging, row editing -->
            <!-- DataTable with editing via sidebar -->
            <p:dataTable id="requestsTable"
                         widgetVar="requestsTable"
                         var="req"
                         value="#{visitRequestControllerResident.userRequests}"
                         reflow="true"
                         rowKey="#{req.id}"
                         paginator="true"
                         rows="10"
                         selectionRowMode="add"
                         paginatorPosition="bottom"
                         selection="#{visitRequestControllerResident.selectedRequests}"
                         styleClass="w-full border rounded-md mt-2"
                         filteredValue="#{visitRequestControllerResident.filteredRequests}"
                         globalFilterFunction="#{visitRequestControllerResident.globalFilterFunction}">

                <!-- Global search bar -->
                <f:facet name="header">
                    <div class="flex justify-between">
            <span class="filter-container ui-input-icon-left">
                <i class="pi pi-search"></i>
                <p:inputText id="globalFilter"
                             onkeyup="PF('requestsTable').filter()"
                             placeholder="Search all fields"/>
            </span>
                    </div>
                </f:facet>

                <!-- Multi-select checkbox column -->
                <p:column selectionMode="multiple" exportable="false" style="width:1px"/>

                <!-- Verification Code column -->
                <p:column headerText="Verification Code" sortBy="#{req.verificationCode}">
                    <h:outputText value="#{req.verificationCode}"/>
                </p:column>

                <!-- Visit Date/Time column -->
                <p:column headerText="Visit Date/Time" sortBy="#{req.visitDateTime}">
                    <h:outputText value="#{req.visitDateTime}">
                        <f:convertDateTime pattern="MM/dd/yy HH:mm"/>
                    </h:outputText>
                </p:column>

                <!-- Number of Entries column -->
                <p:column headerText="Number of Entries" sortBy="#{req.numberOfEntries}">
                    <h:outputText value="#{req.numberOfEntries}"/>
                </p:column>

                <!-- Purpose column -->
                <p:column headerText="Purpose" sortBy="#{req.purpose}">
                    <h:outputText value="#{req.purpose}"/>
                </p:column>

                <!-- Status column (non-editable) -->
                <p:column headerText="Status" sortBy="#{req.status}">
                    <p:tag severity="#{req.status eq 'PENDING' ? 'warning' :
                          req.status eq 'APPROVED' ? 'info' :
                          req.status eq 'COMPLETED' ? 'success' :
                          req.status eq 'CANCELLED' ? 'info' : 'danger'}"
                           value="#{req.status}"/>
                </p:column>

                <!-- Remarks column (non-editable) -->
                <p:column headerText="Remarks" sortBy="#{req.remarks}">
                    <h:outputText value="#{req.remarks}"/>
                </p:column>

                <!-- Updated At column -->
                <p:column headerText="Updated At" sortBy="#{req.updatedAt}">
                    <pe:timeAgo value="#{req.updatedAt}" titlePattern="MM/dd/yy HH:mm"/>
                </p:column>

                <!-- Created At column -->
                <p:column headerText="Created At" sortBy="#{req.createdAt}">
                    <pe:timeAgo value="#{req.createdAt}" titlePattern="MM/dd/yy HH:mm"/>
                </p:column>

                <!-- Actions Column: Edit & Cancel -->
                <p:column headerText="Actions">
                    <p:commandButton value="Edit"
                                     icon="pi pi-pencil"
                                     action="#{visitRequestControllerResident.prepareEdit(req)}"
                                     update=":editRequestForm"
                                     oncomplete="PF('editRequestSidebar').show();"/>
                </p:column>

            </p:dataTable>

        </h:form>

        <!-- Sidebar for Editing a Visit Request -->
        <p:sidebar id="editRequestSidebar"
                   widgetVar="editRequestSidebar"
                   position="right"
                   style="width:600px;">
            <h:form id="editRequestForm">
                <div class="space-y-4">
                    <!-- Sidebar Title -->
                    <h2 class="text-xl font-semibold mb-4">Edit Visit Request</h2>

                    <!-- Verification Code (Read-only) -->
                    <div class="field mb-4">
                        <p:outputLabel for="editVerificationCode" value="Verification Code" styleClass="block mb-1"/>
                        <p:inputText id="editVerificationCode"
                                     value="#{visitRequestControllerResident.editingRequest.verificationCode}"
                                     readonly="true"
                                     styleClass="w-full"/>
                    </div>

                    <!-- Visit Date/Time -->
                    <div class="field mb-4">
                        <p:outputLabel for="editVisitDateTime" value="Visit Date/Time" styleClass="block mb-1"/>
                        <p:datePicker id="editVisitDateTime"
                                      value="#{visitRequestControllerResident.editingRequest.visitDateTime}"
                                      pattern="MM/dd/yy HH:mm"
                                      showTime="true"
                                      converter="timestampConverter"
                                      required="true"
                                      styleClass="w-full"/>
                    </div>

                    <!-- Number of Entries -->
                    <div class="field mb-4">
                        <p:outputLabel for="editNumberOfEntries" value="Number of Entries" styleClass="block mb-1"/>
                        <p:inputText id="editNumberOfEntries"
                                     value="#{visitRequestControllerResident.editingRequest.numberOfEntries}"
                                     required="true"
                                     styleClass="w-full"/>
                    </div>

                    <!-- Purpose -->
                    <div class="field mb-4">
                        <p:outputLabel for="editPurpose" value="Purpose" styleClass="block mb-1"/>
                        <p:inputTextarea id="editPurpose"
                                         value="#{visitRequestControllerResident.editingRequest.purpose}"
                                         required="true"
                                         rows="3"
                                         styleClass="w-full"/>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex justify-content-end gap-4">
                        <p:commandButton value="Revoke"
                                         icon="pi pi-ban"
                                         action="#{visitRequestControllerResident.revokeRequest}"
                                         update=":requestsTableForm:requestsTable :messages"
                                         styleClass="ui-button-danger"
                                         oncomplete="PF('editRequestSidebar').hide();"
                                         rendered="#{visitRequestControllerResident.editingRequest.status eq 'PENDING'}" />
                        <p:commandButton value="Cancel"
                                         icon="pi pi-times"
                                         onclick="PF('editRequestSidebar').hide(); return false;"
                                         styleClass="p-button-text mr-2 ui-button-warning"
                                         immediate="true"/>
                        <p:commandButton value="Save"
                                         icon="pi pi-check"
                                         action="#{visitRequestControllerResident.updateRequest}"
                                         update=":requestsTableForm:requestsTable :messages"
                                         styleClass="p-button-primary"
                                         oncomplete="if (!args.validationFailed) { PF('editRequestSidebar').hide(); }"/>
                    </div>
                </div>
            </h:form>
        </p:sidebar>

    </ui:define>
</ui:composition>
